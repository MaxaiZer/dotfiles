steps:
  - id: fix-shutdown-timeout
    os: "linux"
    script: |
      set -e
      CONF="/etc/systemd/system.conf"

      if [[ ! -f "$CONF" ]]; then
        echo "âŒ system.conf Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
        exit 1
      fi

      if grep -Eq '^\s*#?\s*DefaultTimeoutStopSec=' "$CONF"; then
        sudo sed -Ei 's|^\s*#?\s*DefaultTimeoutStopSec=.*|DefaultTimeoutStopSec=15s|' "$CONF"
      else
        echo "DefaultTimeoutStopSec=15s" | sudo tee -a "$CONF" > /dev/null
      fi

      echo "âœ… DefaultTimeoutStopSec ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð½Ð° 15s"

      systemctl daemon-reexec
      echo "ðŸ”„ Systemd Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½"

  - id: fix-small-swap-btrfs
    os: "linux"
    when: |
      fs_type=$(findmnt -n -o FSTYPE /swap)
      [ "$fs_type" = "btrfs" ]
    script: |
      set -e
      sudo swapoff /swap/swapfile
      sudo rm /swap/swapfile
      sudo btrfs filesystem mkswapfile --size 8g /swap/swapfile
      sudo mkswap /swap/swapfile
      sudo swapon /swap/swapfile

  - id: fix-disable-firewalld #because it blocks autodetection of shared folders
    os: "linux"
    when: systemctl is-active --quiet firewalld && exit 0 || exit 1
    script: sudo systemctl disable firewalld

  - id: fix-enable-sysrq #nvidia driver can crush, REISUB time!
    os: "linux"
    when: |
      [ "$(cat /proc/sys/kernel/sysrq 2>/dev/null || echo 0)" != "1" ]
    script: |
      set -e
      CONF="/etc/sysctl.d/99-sysrq.conf"
      echo "kernel.sysrq = 1" | sudo tee "$CONF" > /dev/null
      sudo sysctl --system
