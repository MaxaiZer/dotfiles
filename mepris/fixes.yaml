steps:
  - id: fix-shutdown-timeout
    os: "linux"
    script: |
      set -e
      CONF="/etc/systemd/system.conf"

      if [[ ! -f "$CONF" ]]; then
        echo "‚ùå system.conf –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
      fi

      if grep -Eq '^\s*#?\s*DefaultTimeoutStopSec=' "$CONF"; then
        sudo sed -Ei 's|^\s*#?\s*DefaultTimeoutStopSec=.*|DefaultTimeoutStopSec=15s|' "$CONF"
      else
        echo "DefaultTimeoutStopSec=15s" | sudo tee -a "$CONF" > /dev/null
      fi

      echo "‚úÖ DefaultTimeoutStopSec —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 15s"

      systemctl daemon-reexec
      echo "üîÑ Systemd –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"

  - id: fix-small-swap-btrfs
    os: "linux"
    when: |
      fs_type=$(findmnt -n -o FSTYPE /swap)
      [ "$fs_type" = "btrfs" ]
    script: |
      set -e
      sudo swapoff /swap/swapfile
      sudo rm /swap/swapfile
      sudo btrfs filesystem mkswapfile --size 8g /swap/swapfile
      sudo mkswap /swap/swapfile
      sudo swapon /swap/swapfile

  - id: fix-disable-firewalld #because it blocks autodetection of shared folders
    os: "linux"
    when: systemctl is-active --quiet firewalld && exit 0 || exit 1
    script: sudo systemctl disable firewalld
