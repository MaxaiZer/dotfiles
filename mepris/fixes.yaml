steps:
  - id: fix-shutdown-timeout
    os: "linux"
    script: |
      set -e
      SERVICE_FILE=""
      for path in /usr/lib/systemd/system/user@.service; do
        if [[ -f "$path" ]]; then
          SERVICE_FILE="$path"
          break
        fi
      done

      if [[ -z "$SERVICE_FILE" ]]; then
        echo "‚ùå user@.service –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
      fi

      if grep -q '^TimeoutStopSec=' "$SERVICE_FILE"; then
        sudo sed -i 's/^TimeoutStopSec=.*/TimeoutStopSec=4s/' "$SERVICE_FILE"
      else
        sudo sed -i '/^\[Service\]/a TimeoutStopSec=4s' "$SERVICE_FILE"
      fi

      echo "‚úÖ TimeoutStopSec —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 4s"

      systemctl daemon-reexec
      systemctl daemon-reload
      echo "üîÑ Systemd –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"

  - id: fix-small-swap-btrfs
    os: "linux"
    when: |
      fs_type=$(findmnt -n -o FSTYPE /swap)
      [ "$fs_type" = "btrfs" ]
    script: |
      set -e
      sudo swapoff /swap/swapfile
      sudo rm /swap/swapfile
      sudo btrfs filesystem mkswapfile --size 8g /swap/swapfile
      sudo mkswap /swap/swapfile
      sudo swapon /swap/swapfile

